<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Chat Platform</title>
<style>
body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
input, button, textarea, select { display: block; margin: 10px 0; width: 100%; padding: 8px; }
.section { border: 1px solid #ddd; padding: 15px; margin: 20px 0; border-radius: 5px; }
.chat-message { background: #f1f1f1; padding: 8px; border-radius: 4px; margin: 5px 0; }
.hint { font-size: 12px; color: #555; }
</style>
</head>
<body>

<h1>AI Chat Platform</h1>

<!-- REGISTER -->
<div class="section" id="register-section">
  <h2>Register</h2>
  <input type="email" id="reg-email" placeholder="Email">
  <input type="password" id="reg-pass" placeholder="Password">
  <button type="button" id="register-btn">Register</button>
  <div id="reg-result"></div>
</div>

<!-- LOGIN -->
<div class="section" id="login-section">
  <h2>Login</h2>
  <input type="email" id="login-email" placeholder="Email">
  <input type="password" id="login-pass" placeholder="Password">
  <button type="button" id="login-btn">Login</button>
  <div id="login-result"></div>
</div>

<!-- PROJECTS -->
<div class="section" id="project-section" style="display:none;">
  <h2>Projects</h2>
  <input type="text" id="project-name" placeholder="Project name">
  <button type="button" id="create-project-btn">Create Project</button>
  <div id="project-result"></div>
  <select id="project-list"></select>
  <button type="button" id="toggle-prompt-btn">⚙️ Bot Settings</button>
</div>

<!-- BOT INSTRUCTIONS -->
<div class="section" id="prompt-section" style="display:none;">
  <h2>Bot Instructions (Optional)</h2>
  <p class="hint">Define how the chatbot should behave for this project.</p>
  <textarea id="prompt-content" rows="3"></textarea>
  <button type="button" id="save-prompt-btn">Save Instructions</button>
  <div id="prompt-result"></div>
</div>

<!-- CHAT -->
<div class="section" id="chat-section" style="display:none;">
  <h2>Chat</h2>
  <textarea id="chat-input" placeholder="Type your message"></textarea>
  <button type="button" id="send-chat-btn">Send</button>
  <div id="chat-output"></div>
</div>

<script>
let token = "";
let currentProjectId = "";
const BASE_URL = "https://ai-chat-platform-t51m.onrender.com";

// ------------------------
// EVENT LISTENERS
// ------------------------
document.getElementById("register-btn").addEventListener("click", registerUser);
document.getElementById("login-btn").addEventListener("click", loginUser);
document.getElementById("create-project-btn").addEventListener("click", createProject);
document.getElementById("toggle-prompt-btn").addEventListener("click", togglePrompt);
document.getElementById("save-prompt-btn").addEventListener("click", addPrompt);
document.getElementById("send-chat-btn").addEventListener("click", sendChat);

// Prevent Enter key from submitting forms
document.querySelectorAll("input, textarea").forEach(el => {
  el.addEventListener("keypress", e => {
    if(e.key === "Enter") e.preventDefault();
  });
});

// ------------------------
// FUNCTIONS
// ------------------------
function togglePrompt() {
  const section = document.getElementById("prompt-section");
  section.style.display = section.style.display === "none" ? "block" : "none";
}

// Register
async function registerUser() {
  const email = document.getElementById("reg-email").value;
  const password = document.getElementById("reg-pass").value;

  try {
    const res = await fetch(`${BASE_URL}/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const text = await res.text();
    document.getElementById("reg-result").innerText = text;
  } catch(e) {
    document.getElementById("reg-result").innerText = e;
  }
}

// Login
async function loginUser() {
  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-pass").value;

  try {
    const res = await fetch(`${BASE_URL}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (!res.ok) {
      document.getElementById("login-result").innerText = data.error || "Login failed";
      return;
    }

    token = data.token;
    document.getElementById("login-result").innerText = "Logged in";
    document.getElementById("project-section").style.display = "block";
    document.getElementById("chat-section").style.display = "block";
    loadProjects();
  } catch(e) {
    document.getElementById("login-result").innerText = e;
  }
}

// Create Project
async function createProject() {
  const name = document.getElementById("project-name").value;
  if (!name) return;

  try {
    const res = await fetch(`${BASE_URL}/projects`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      },
      body: JSON.stringify({ name })
    });
    const data = await res.json();
    document.getElementById("project-result").innerText = "Project created: " + data.name;
    document.getElementById("project-name").value = "";
    await loadProjects();
  } catch(e) {
    document.getElementById("project-result").innerText = e;
  }
}

// Load Projects
async function loadProjects() {
  try {
    const res = await fetch(`${BASE_URL}/projects`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    const select = document.getElementById("project-list");
    select.innerHTML = "";
    data.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.text = p.name;
      select.add(opt);
    });
    if (data.length > 0) currentProjectId = data[0].id;
  } catch(e) {
    console.error("Failed to load projects:", e);
  }
}

// Select Project
document.getElementById("project-list").addEventListener("change", e => {
  currentProjectId = e.target.value;
});

// Add Prompt
async function addPrompt() {
  if (!currentProjectId) { alert("Create or select a project first"); return; }
  const content = document.getElementById("prompt-content").value;
  if (!content) return;

  try {
    const res = await fetch(`${BASE_URL}/projects/${currentProjectId}/prompts`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}` 
      },
      body: JSON.stringify({ content })
    });
    const data = await res.json();
    document.getElementById("prompt-result").innerText = "Instructions saved";
    document.getElementById("prompt-content").value = "";
  } catch(e) {
    document.getElementById("prompt-result").innerText = e;
  }
}

// Send Chat (mock for demo)
async function sendChat() {
  if (!currentProjectId) {
    alert("Create or select a project first");
    return;
  }

  const message = document.getElementById("chat-input").value;
  if (!message) return;

  console.log("Sending message:", message);
  console.log("Project ID:", currentProjectId);

  const res = await fetch(`${BASE_URL}/projects/${currentProjectId}/chat`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({ message })
  });

  const data = await res.json();

  const div = document.createElement("div");
  div.className = "chat-message";
  div.innerText = "AI: " + data.reply;

  document.getElementById("chat-output").appendChild(div);
}

</script>

</body>
</html>
